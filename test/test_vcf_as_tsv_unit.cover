    1: import gzip
    1: import subprocess
    1: import tempfile
    1: import unittest
    1: from pathlib import Path
       
    1: from test.helpers import VerboseTestCase
       
       
    1: REPO_ROOT = Path(__file__).resolve().parents[1]
    1: SCRIPT = REPO_ROOT / "src" / "vcf_as_tsv.sh"
       
       
    2: class VcfAsTsvUnitTests(VerboseTestCase):
    1:     def test_vcf_as_tsv_directory_mode(self):
               """Directory input: converts VCF and normalizes #CHROM header to CHROM."""
    2:         with tempfile.TemporaryDirectory() as td:
    1:             tmp_path = Path(td)
    1:             input_dir = tmp_path / "in"
    1:             input_dir.mkdir()
    1:             output_dir = tmp_path / "tsv"
    2:             (input_dir / "sample.vcf").write_text(
    1:                 "##fileformat=VCFv4.2\n##source=test\n#CHROM\tPOS\tID\n1\t10\trs1\n"
                   )
       
    2:             result = subprocess.run(
    1:                 ["bash", str(SCRIPT), str(input_dir), str(output_dir)],
    1:                 capture_output=True,
    1:                 text=True,
                   )
       
    1:             self.assertEqual(result.returncode, 0, msg=result.stderr)
    1:             out_file = output_dir / "sample.tsv"
    1:             self.assertTrue(out_file.exists())
    1:             lines = out_file.read_text().splitlines()
    1:             self.assertEqual(lines[0], "CHROM\tPOS\tID")
    1:             self.assertEqual(lines[1], "1\t10\trs1")
       
    1:     def test_vcf_as_tsv_single_gz_file_mode(self):
               """Single .vcf.gz input: decompresses and writes expected TSV output."""
    2:         with tempfile.TemporaryDirectory() as td:
    1:             tmp_path = Path(td)
    1:             input_file = tmp_path / "sample.vcf.gz"
    1:             output_dir = tmp_path / "tsv"
    2:             with gzip.open(input_file, "wt") as f:
    1:                 f.write("##fileformat=VCFv4.2\n#CHROM\tPOS\n1\t20\n")
       
    2:             result = subprocess.run(
    1:                 ["bash", str(SCRIPT), str(input_file), str(output_dir)],
    1:                 capture_output=True,
    1:                 text=True,
                   )
       
    1:             self.assertEqual(result.returncode, 0, msg=result.stderr)
    1:             out_file = output_dir / "sample.tsv"
    1:             self.assertTrue(out_file.exists())
    1:             self.assertIn("CHROM\tPOS", out_file.read_text())
       
    1:     def test_vcf_as_tsv_errors_when_no_vcf_files_found(self):
               """Empty directory input: exits non-zero with a clear no-files message."""
    2:         with tempfile.TemporaryDirectory() as td:
    1:             tmp_path = Path(td)
    1:             input_dir = tmp_path / "empty"
    1:             input_dir.mkdir()
    1:             output_dir = tmp_path / "tsv"
       
    2:             result = subprocess.run(
    1:                 ["bash", str(SCRIPT), str(input_dir), str(output_dir)],
    1:                 capture_output=True,
    1:                 text=True,
                   )
       
    1:             self.assertNotEqual(result.returncode, 0)
    1:             self.assertIn("No .vcf or .vcf.gz files found", result.stdout)
       
       
    1: if __name__ == "__main__":
           unittest.main()
