    1: import os
    1: import sys
    1: import tempfile
    1: import unittest
    1: from pathlib import Path
    1: from unittest import mock
       
    1: import vcf_rdfizer
    1: from test.helpers import VerboseTestCase
       
       
    1: def invoke_main(argv):
    6:     with mock.patch.object(sys, "argv", ["vcf_rdfizer.py", *argv]):
    3:         return vcf_rdfizer.main()
       
       
    1: def prepare_inputs(base: Path):
    3:     input_dir = base / "input"
    3:     input_dir.mkdir()
    3:     (input_dir / "sample.vcf").write_text("##fileformat=VCFv4.2\n#CHROM\tPOS\n1\t10\n")
    3:     rules_path = base / "rules.ttl"
    3:     rules_path.write_text("@prefix ex: <http://example.org/> .\n")
    3:     return input_dir, rules_path
       
       
    2: class WrapperUnitTests(VerboseTestCase):
    1:     def test_main_happy_path_runs_pipeline_and_passes_compression(self):
               """Wrapper runs all pipeline steps and forwards compression arguments."""
    2:         with tempfile.TemporaryDirectory() as td:
    1:             tmp_path = Path(td)
    1:             input_dir, rules_path = prepare_inputs(tmp_path)
    1:             commands = []
       
    1:             def fake_run(cmd, cwd=None, env=None):
    3:                 commands.append(cmd)
    3:                 return 0
       
    1:             old_cwd = os.getcwd()
    1:             os.chdir(tmp_path)
    1:             try:
    3:                 with mock.patch.object(vcf_rdfizer, "run", side_effect=fake_run), mock.patch.object(
    1:                     vcf_rdfizer, "check_docker", return_value=True
    3:                 ), mock.patch.object(
    1:                     vcf_rdfizer, "docker_image_exists", return_value=True
    3:                 ), mock.patch.object(
    1:                     vcf_rdfizer, "docker_build_image", return_value=1
    3:                 ), mock.patch.object(
    1:                     vcf_rdfizer, "docker_pull_image", return_value=1
                       ):
    2:                     rc = invoke_main(
    1:                         [
    1:                             "--input",
    1:                             str(input_dir),
    1:                             "--rules",
    1:                             str(rules_path),
    1:                             "--compression",
    1:                             "none",
    1:                             "--keep-tsv",
                               ]
                           )
                   finally:
    1:                 os.chdir(old_cwd)
       
    1:             self.assertEqual(rc, 0)
    1:             self.assertEqual(len(commands), 3)
    1:             self.assertIn("/opt/vcf-rdfizer/vcf_as_tsv.sh", commands[0])
    1:             self.assertIn("/opt/vcf-rdfizer/run_conversion.sh", commands[1])
    1:             self.assertIn("/opt/vcf-rdfizer/compression.sh", commands[2])
    1:             self.assertEqual(commands[2][-2:], ["-m", "none"])
       
    1:     def test_main_errors_when_versioned_image_does_not_exist(self):
               """Wrapper returns a user error when a requested image version cannot be pulled."""
    2:         with tempfile.TemporaryDirectory() as td:
    1:             tmp_path = Path(td)
    1:             input_dir, rules_path = prepare_inputs(tmp_path)
       
    1:             old_cwd = os.getcwd()
    1:             os.chdir(tmp_path)
    1:             try:
    3:                 with mock.patch.object(vcf_rdfizer, "check_docker", return_value=True), mock.patch.object(
    1:                     vcf_rdfizer, "docker_image_exists", return_value=False
    3:                 ), mock.patch.object(
    1:                     vcf_rdfizer, "docker_pull_image", return_value=1
    3:                 ), mock.patch.object(
    1:                     vcf_rdfizer, "run", return_value=0
                       ):
    2:                     rc = invoke_main(
    1:                         [
    1:                             "--input",
    1:                             str(input_dir),
    1:                             "--rules",
    1:                             str(rules_path),
    1:                             "--image",
    1:                             "example/vcf-rdfizer",
    1:                             "--image-version",
    1:                             "9.9.9",
                               ]
                           )
                   finally:
    1:                 os.chdir(old_cwd)
       
    1:             self.assertEqual(rc, 2)
       
    1:     def test_main_no_build_fails_if_local_image_missing(self):
               """Wrapper fails fast with --no-build when no local image is available."""
    2:         with tempfile.TemporaryDirectory() as td:
    1:             tmp_path = Path(td)
    1:             input_dir, rules_path = prepare_inputs(tmp_path)
       
    1:             old_cwd = os.getcwd()
    1:             os.chdir(tmp_path)
    1:             try:
    3:                 with mock.patch.object(vcf_rdfizer, "check_docker", return_value=True), mock.patch.object(
    1:                     vcf_rdfizer, "docker_image_exists", return_value=False
    3:                 ), mock.patch.object(
    1:                     vcf_rdfizer, "run", return_value=0
                       ):
    2:                     rc = invoke_main(
    1:                         [
    1:                             "--input",
    1:                             str(input_dir),
    1:                             "--rules",
    1:                             str(rules_path),
    1:                             "--no-build",
                               ]
                           )
                   finally:
    1:                 os.chdir(old_cwd)
       
    1:             self.assertEqual(rc, 2)
       
    1:     def test_resolve_image_ref_accepts_repo_plus_version(self):
               """Image repository and explicit version resolve to a tagged image reference."""
    1:         ref, requested = vcf_rdfizer.resolve_image_ref("vcf-rdfizer", "1.2.3")
    1:         self.assertEqual(ref, "vcf-rdfizer:1.2.3")
    1:         self.assertTrue(requested)
       
       
    1: if __name__ == "__main__":
           unittest.main()
